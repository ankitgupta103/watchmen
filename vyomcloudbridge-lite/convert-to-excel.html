<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Log Data to XLSX Converter</title>
  <!-- Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS library for creating .xlsx files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* Using a common font for a clean look */
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
  <!-- Google Fonts for Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">

  <div class="w-full max-w-3xl mx-auto p-6 md:p-8 bg-white rounded-xl shadow-lg">
    <div class="text-center mb-6">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Log Data to XLSX Converter</h1>
      <p class="text-gray-600 mt-2">Paste the console output from your sensor script to generate a downloadable XLSX
        file.</p>
    </div>

    <!-- Text area for user to paste log data -->
    <div class="mb-4">
      <label for="logData" class="block text-sm font-medium text-gray-700 mb-1">Paste Log Data Here:</label>
      <textarea id="logData" rows="12"
        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
        placeholder="timestamp_ms,location_id,diff_value,motion_detected,person_present_ground_truth,image_filename&#10;1678886400000,LOC_005,42,True,False,LOC_005-1678886400000-True.jpg&#10;..."></textarea>
    </div>

    <!-- Button to trigger the download -->
    <button id="downloadBtn"
      class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105">
      Generate and Download .XLSX File
    </button>

    <!-- Message area for feedback -->
    <div id="message" class="text-center mt-4 text-sm font-medium"></div>
  </div>

  <script>
    // Get references to the HTML elements
    const downloadBtn = document.getElementById('downloadBtn');
    const logDataTextArea = document.getElementById('logData');
    const messageDiv = document.getElementById('message');

    // Add a click event listener to the button
    downloadBtn.addEventListener('click', () => {
      // 1. Get the text from the textarea
      const logContent = logDataTextArea.value.trim();

      if (!logContent) {
        messageDiv.textContent = 'Please paste some data into the text area first.';
        messageDiv.className = 'text-center mt-4 text-sm font-medium text-red-600';
        return;
      }

      try {
        // 2. Parse the text data into an array of arrays
        const header = "timestamp_ms,location_id,diff_value,motion_detected,person_present_ground_truth,image_filename";
        const lines = logContent.split('\n');

        // Start with the header row
        const data = [header.split(',')];

        // Check if the first line of pasted data is the header, if so, skip it
        const startIndex = lines[0].trim().startsWith('timestamp_ms') ? 1 : 0;

        for (let i = startIndex; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line) { // Ensure we don't process empty lines
            data.push(line.split(','));
          }
        }

        // 3. Use SheetJS to create a workbook
        // Create a new worksheet from our array of arrays
        const ws = XLSX.utils.aoa_to_sheet(data);

        // Create a new workbook
        const wb = XLSX.utils.book_new();

        // Append the worksheet to the workbook with a sheet name
        XLSX.utils.book_append_sheet(wb, ws, "LogData");

        // 4. Trigger the download of the .xlsx file
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        XLSX.writeFile(wb, `datalog_${timestamp}.xlsx`);

        // Provide success feedback to the user
        messageDiv.textContent = 'Success! Your XLSX file has been downloaded.';
        messageDiv.className = 'text-center mt-4 text-sm font-medium text-green-600';

      } catch (error) {
        console.error("Error generating XLSX file:", error);
        messageDiv.textContent = 'An error occurred while generating the file.';
        messageDiv.className = 'text-center mt-4 text-sm font-medium text-red-600';
      }
    });
  </script>

</body>

</html>